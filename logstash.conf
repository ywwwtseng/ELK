input {
  beats {
    port => 5044
  }
}

filter {
  # 解析 Pino 日誌中的 JSON 格式
  json {
    source => "message"
  }

  # 將 level 字段從數字轉換為字符串
  mutate {
    convert => { "level" => "string" }
  }

  # 將 level 數字轉換為文字
  mutate {
    gsub => [
      "level", "10", "trace",
      "level", "20", "debug",
      "level", "30", "info",
      "level", "40", "warn",
      "level", "50", "error",
      "level", "60", "fatal"
    ]
  }

  # 格式化時間戳，從 Unix 時間戳轉換為標準日期格式
  date {
    match => [ "time", "UNIX_MS" ]
    target => "time"
  }

  # 刪除不需要的字段
  mutate {
    remove_field => ["pid", "hostname", "@version", "host"]
  }

  # 添加新的字段或嵌套結構
  mutate {
    add_field => {
      "[http][method]" => "%{[req][method]}"
      "[http][url]" => "%{[req][url]}"
      "[http][status_code]" => "%{[res][statusCode]}"
    }
  }

  # 刪除原始的 req 和 res
  mutate {
    remove_field => ["req", "res"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "changeme"
    index => "http-requests-%{+YYYY.MM.dd}"
  }
  stdout { codec => rubydebug }
}